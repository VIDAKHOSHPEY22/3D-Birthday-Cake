<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Birthday Surprise</title>
    <link rel="icon" href="/public/favicon.ico" type="image/x-icon">
    <link href="style.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!-- New name input screen -->
    <div id="name-input-screen" class="show">
        <div class="input-container">
            <h2><i class="fas fa-cake-candles"></i> Enter Your Name <i class="fas fa-cake-candles"></i></h2>
            <p class="main-instruction">Type your name below to personalize your birthday celebration!</p>
            <div class="input-wrapper">
                <i class="fas fa-user-pen input-icon"></i>
                <input type="text" id="user-name-input" placeholder="Enter your name here..." maxlength="20">
            </div>
            <button id="start-celebration-btn">
                <i class="fas fa-sparkles"></i> Start Celebration! <i class="fas fa-party-horn"></i>
            </button>
            <p class="tip"><i class="fas fa-lightbulb"></i> Your name will appear in the birthday message</p>
        </div>
    </div>

    <div id="volume-reminder">
        <h2>Let's Celebrate! <i class="fas fa-confetti"></i></h2>
        <p class="main-instruction"><i class="fas fa-music"></i> Turn up your volume and click to begin the birthday song!</p>
        <p class="sub-instruction"><i class="fas fa-candle-holder"></i> After the music, blow out the candles!</p>
        <p class="tip"> <i class="fas fa-hand-point-down"></i>
            Tap or Click anywhere<br>to see the cake and start the song!
    </p>
    </div>
    
    <audio id="happy-birthday-audio">
        <source src="/happy-birthday.mp3" type="audio/mpeg">
    </audio>
    
    <div id="hold-reminder">
        <h2><i class="fas fa-wand-magic-sparkles"></i> Make a Magical Wish! <i class="fas fa-wand-magic-sparkles"></i></h2>
        <p class="main-instruction"><i class="fas fa-fire-flame-curved"></i> Now it's time to blow out the candles!</p>
        <p class="sub-instruction"><i class="fas fa-seedling"></i> Make your secret birthday wish come true!</p>
    </div>
    
    <!-- ØªØ§ÛŒÙ…Ø± Ù…Ø¹Ú©ÙˆØ³ Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª ØªØºÛŒÛŒØ± Ù…ØªÙ† -->
    <div class="song-countdown" id="song-countdown">
        <div class="countdown-number" id="countdown-number">38</div>
        <div class="countdown-label" id="countdown-label">
            <span>Song Time</span>
            <small>seconds remaining</small>
        </div>
    </div>
    
    <div id="congratulation-overlay">
        <div id="congratulation-text">
            <h3><i class="fas fa-gift"></i> Happy Birthday! <i class="fas fa-gift"></i></h3>
            <!-- Personalized name will appear here -->
            <h4 id="personalized-name"></h4>
        </div>
    </div>

    <!-- Ú©Ø§Ù†ÙˆØ§Ø³ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø§ÙÚ©Øª Ú©Ù†ÙØªÛŒ -->
    <canvas id="confetti-canvas"></canvas>
    
    <script>
        // Store user name globally
        let userName = "";
        
        // Name input functionality
        const nameInputScreen = document.getElementById('name-input-screen');
        const userNameInput = document.getElementById('user-name-input');
        const startCelebrationBtn = document.getElementById('start-celebration-btn');
        const volumeReminder = document.getElementById('volume-reminder');
        const audio = document.getElementById('happy-birthday-audio');
        const personalizedNameElement = document.getElementById('personalized-name');
        
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ØªØ§ÛŒÙ…Ø± Ù…Ø¹Ú©ÙˆØ³ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡
        const songCountdown = document.getElementById('song-countdown');
        const countdownNumber = document.getElementById('countdown-number');
        const countdownLabel = document.getElementById('countdown-label'); // Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ù…ØªÙ†
        let songCountdownValue = 38;
        let songCountdownInterval;
        
        // ØªØ§Ø¨Ø¹ Ø´Ø±ÙˆØ¹ ØªØ§ÛŒÙ…Ø± Ù…Ø¹Ú©ÙˆØ³ (Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù‡)
        function startSongCountdown() {
            songCountdownValue = 38;
            countdownNumber.textContent = songCountdownValue;
            countdownLabel.innerHTML = `<span>Song Time</span><small>seconds remaining</small>`;
            songCountdown.style.display = 'flex';
            
            songCountdownInterval = setInterval(() => {
                songCountdownValue--;
                countdownNumber.textContent = songCountdownValue;
                
                if (songCountdownValue <= 0) {
                    clearInterval(songCountdownInterval);
                    // ÙˆÙ‚ØªÛŒ Ø¢Ù‡Ù†Ú¯ ØªÙ…ÙˆÙ… Ø´Ø¯ â†’ Ù†Ù…Ø§ÛŒØ´ "Wait..."
                    countdownNumber.textContent = 'â˜…';
                    countdownLabel.innerHTML = `
                        <span style="font-size: 1.1em; font-weight: bold;">Wait...</span>
                        <small>getting ready</small>
                    `;
                }
            }, 1000);
        }
        
        // Start celebration when button is clicked
        startCelebrationBtn.addEventListener("click", function () {
            userName = userNameInput.value.trim();
            
            // If no name entered, use default
            if (!userName) {
                userName = "Friend";
            }
            
            // Store the name for later use
            localStorage.setItem('birthdayUserName', userName);
            
            // ØªÙ†Ø¸ÛŒÙ… Ù†Ø§Ù… Ø¯Ø± Ø§Ù„Ù…Ø§Ù† Ù†Ù…Ø§ÛŒØ´
            if (personalizedNameElement) {
                personalizedNameElement.innerHTML = `<i class="fas fa-birthday-cake"></i> ${userName}! <i class="fas fa-balloon"></i>`;
            }
            
            // Hide name input screen
            nameInputScreen.classList.remove('show');
            setTimeout(function () {
                nameInputScreen.style.display = 'none';
            }, 1000);
            
            // Show volume reminder
            volumeReminder.style.display = 'flex';
            setTimeout(function () {
                volumeReminder.classList.add('show');
            }, 50);
        });
        
        // Allow pressing Enter to start
        userNameInput.addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                startCelebrationBtn.click();
            }
        });
        
        // Set personalized name when congratulation appears
        window.addEventListener('load', function () {
            // Check if we have a stored name from script.js
            const storedName = localStorage.getItem('birthdayUserName');
            if (storedName && personalizedNameElement) {
                personalizedNameElement.innerHTML = `<i class="fas fa-birthday-cake"></i> ${userName}! <i class="fas fa-balloon"></i>`;
                userName = storedName;
            }
        });
        
        // Original volume reminder functionality
        volumeReminder.addEventListener("click", function () {
            audio.play();
            volumeReminder.classList.remove('show');
            setTimeout(function () {
                volumeReminder.style.display = 'none';
            }, 1000);
            
            // Ø´Ø±ÙˆØ¹ ØªØ§ÛŒÙ…Ø± Ù…Ø¹Ú©ÙˆØ³ ÙˆÙ‚ØªÛŒ Ø¢Ù‡Ù†Ú¯ Ù¾Ø®Ø´ Ù…ÛŒâ€ŒØ´ÙˆØ¯
            startSongCountdown();

            // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§ÙÚ©Øª Ú©Ù†ÙØªÛŒ Ø¬Ø¯ÛŒØ¯
            startConfetti();
        });
        
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† interval Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØµÙØ­Ù‡
        window.addEventListener('beforeunload', function() {
            if (songCountdownInterval) clearInterval(songCountdownInterval);
        });

        // ================== ÙˆÛŒÚ˜Ú¯ÛŒ Ø¬Ø¯ÛŒØ¯: ØªØ´Ø®ÛŒØµ Ù†Ù…Ø§ÛŒØ´ hold-reminder Ùˆ ØªØºÛŒÛŒØ± Ù…ØªÙ† Ø¨Ù‡ "Blow!" ==================
        const holdReminder = document.getElementById('hold-reminder');
        const observer = new MutationObserver(() => {
            if (holdReminder.style.display === 'flex' || holdReminder.style.display === 'block' || 
                window.getComputedStyle(holdReminder).display !== 'none') {
                
                songCountdown.style.display = 'flex'; // Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡ Ø§Ú¯Ø± Ù…Ø®ÙÛŒ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯
                countdownNumber.textContent = 'ğŸ¤';
                countdownLabel.innerHTML = `
                    <span style="font-size: 1.3em; font-weight: bold; letter-spacing: 1px;">Blow!</span>
                    <small>into microphone</small>
                `;
            }
        });

        observer.observe(holdReminder, {
            attributes: true,
            attributeFilter: ['style', 'class']
        });

        // Ù‡Ù…Ú†Ù†ÛŒÙ† Ú†Ú© Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø± ØµÙˆØ±Øª Ù„ÙˆØ¯ Ø´Ø¯Ù† ØµÙØ­Ù‡ Ø¨Ø§ Ø­Ø§Ù„Øª ÙØ¹Ø§Ù„
        if (window.getComputedStyle(holdReminder).display !== 'none') {
            countdownNumber.textContent = 'ğŸ¤';
            countdownLabel.innerHTML = `<span style="font-size: 1.3em; font-weight: bold;">Blow!</span><small>into microphone</small>`;
            songCountdown.style.display = 'flex';
        }
        // =================================================================================================

        // ================== ÙˆÛŒÚ˜Ú¯ÛŒ Ø¬Ø¯ÛŒØ¯: Ø§ÙÚ©Øª Ú©Ù†ÙØªÛŒ ==================
        const confettiCanvas = document.getElementById('confetti-canvas');
        const ctx = confettiCanvas.getContext('2d');
        let confettiParticles = [];
        let confettiAnimation;

        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;

        window.addEventListener('resize', () => {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
        });

        function randomColor() {
            const colors = ['#ff3366', '#ff9933', '#ffd700', '#ff69b4', '#00ffcc', '#ff4500', '#9400d3', '#00bfff'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function createConfetti() {
            return {
                x: Math.random() * confettiCanvas.width,
                y: -10,
                size: Math.random() * 8 + 5,
                speedY: Math.random() * 3 + 2,
                speedX: Math.random() * 3 - 1.5,
                rotation: Math.random() * 360,
                rotationSpeed: Math.random() * 10 - 5,
                color: randomColor(),
                opacity: 1
            };
        }

        function startConfetti() {
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ù†ÙØªÛŒ Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´Øª
            cancelAnimationFrame(confettiAnimation);
            confettiParticles = [];

            function animate() {
                ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);

                // Ø§ÛŒØ¬Ø§Ø¯ Ø°Ø±Ø§Øª Ø¬Ø¯ÛŒØ¯
                if (Math.random() > 0.3) {
                    confettiParticles.push(createConfetti());
                }

                confettiParticles.forEach((p, i) => {
                    p.y += p.speedY;
                    p.x += p.speedX;
                    p.rotation += p.rotationSpeed;
                    p.opacity = 1 - (p.y / confettiCanvas.height);

                    if (p.y > confettiCanvas.height || p.opacity <= 0) {
                        confettiParticles.splice(i, 1);
                    }

                    ctx.save();
                    ctx.globalAlpha = p.opacity;
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 1.5);
                    ctx.restore();
                });

                if (confettiParticles.length > 0 || audio.currentTime < audio.duration - 1) {
                    confettiAnimation = requestAnimationFrame(animate);
                }
            }

            animate();

            // ØªÙˆÙ‚Ù Ø®ÙˆØ¯Ú©Ø§Ø± Ú©Ù†ÙØªÛŒ Ø¨Ø¹Ø¯ Ø§Ø² Ù¾Ø§ÛŒØ§Ù† Ø¢Ù‡Ù†Ú¯
            audio.addEventListener('ended', () => {
                setTimeout(() => {
                    confettiParticles = [];
                    ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
                }, 2000);
            });
        }
        // ============================================================
    </script>
    <script type="module" src="script.js"></script>
</body>

</html>